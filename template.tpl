___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Facebook Pixel by Stape",
  "categories": [
    "ADVERTISING",
    "ANALYTICS",
    "CONVERSIONS",
    "MARKETING",
    "REMARKETING"
  ],
  "brand": {
    "id": "brand_dummy",
    "displayName": "stape.io",
    "thumbnail": "data:image/png;base64,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"
  },
  "description": "Integrates the Facebook/Meta Pixel into the page and allows easy event tracking.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "pixelIds",
    "displayName": "Facebook Pixel ID(s)",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      },
      {
        "type": "REGEX",
        "args": [
          "^[0-9,]+$"
        ]
      }
    ],
    "help": "Set to a valid Facebook Pixel ID."
  },
  {
    "type": "SELECT",
    "name": "inheritEventName",
    "displayName": "Event Name Setup Method",
    "selectItems": [
      {
        "value": "inherit",
        "displayValue": "Inherit from DataLayer"
      },
      {
        "value": "override",
        "displayValue": "Override"
      }
    ],
    "simpleValueType": true,
    "subParams": [
      {
        "type": "RADIO",
        "name": "eventName",
        "radioItems": [
          {
            "value": "standard",
            "displayValue": "Standard",
            "subParams": [
              {
                "type": "SELECT",
                "name": "eventNameStandard",
                "macrosInSelect": false,
                "selectItems": [
                  {
                    "value": "PageView",
                    "displayValue": "PageView"
                  },
                  {
                    "value": "AddPaymentInfo",
                    "displayValue": "AddPaymentInfo"
                  },
                  {
                    "value": "AddToCart",
                    "displayValue": "AddToCart"
                  },
                  {
                    "value": "AddToWishlist",
                    "displayValue": "AddToWishlist"
                  },
                  {
                    "value": "CompleteRegistration",
                    "displayValue": "CompleteRegistration"
                  },
                  {
                    "value": "Contact",
                    "displayValue": "Contact"
                  },
                  {
                    "value": "CustomizeProduct",
                    "displayValue": "CustomizeProduct"
                  },
                  {
                    "value": "Donate",
                    "displayValue": "Donate"
                  },
                  {
                    "value": "FindLocation",
                    "displayValue": "FindLocation"
                  },
                  {
                    "value": "InitiateCheckout",
                    "displayValue": "InitiateCheckout"
                  },
                  {
                    "value": "Lead",
                    "displayValue": "Lead"
                  },
                  {
                    "value": "Purchase",
                    "displayValue": "Purchase"
                  },
                  {
                    "value": "Schedule",
                    "displayValue": "Schedule"
                  },
                  {
                    "value": "Search",
                    "displayValue": "Search"
                  },
                  {
                    "value": "StartTrial",
                    "displayValue": "StartTrial"
                  },
                  {
                    "value": "SubmitApplication",
                    "displayValue": "SubmitApplication"
                  },
                  {
                    "value": "Subscribe",
                    "displayValue": "Subscribe"
                  },
                  {
                    "value": "ViewContent",
                    "displayValue": "ViewContent"
                  }
                ],
                "simpleValueType": true
              }
            ]
          },
          {
            "value": "custom",
            "displayValue": "Custom",
            "subParams": [
              {
                "type": "TEXT",
                "name": "eventNameCustom",
                "simpleValueType": true
              }
            ]
          }
        ],
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "inheritEventName",
            "paramValue": "override",
            "type": "EQUALS"
          }
        ],
        "displayName": "Event Type"
      }
    ]
  },
  {
    "type": "CHECKBOX",
    "name": "enableDataLayerMapping",
    "checkboxText": "Enable automatic data population from the Data Layer",
    "simpleValueType": true,
    "help": "If you check this, then the Facebook tag will populate standard Object Properties and User Properties automatically from the DataLayer. Tag parse Universal Anlytics,  \u003ca target\u003d\"_blank\" href\u003d\"https://developers.google.com/analytics/devguides/collection/ga4/ecommerce\"\u003eGA4\u003c/a\u003e and \u003ca target\u003d\"_blank\" href\u003d\"https://developers.google.com/tag-platform/tag-manager/server-side/common-event-data\"\u003eCommon Event Data\u003c/a\u003e formats.",
    "defaultValue": true
  },
  {
    "type": "CHECKBOX",
    "name": "enableCurrentDataLayerOnly",
    "checkboxText": "Use only data from the last DataLayer push",
    "simpleValueType": true,
    "help": "The tag will take data only from the current DataLayer event if enabled. In other words, only data that is pushed to DataLayer last will be used. That\u0027s how it worked in the old Facebook pixel tag.",
    "defaultValue": false,
    "enablingConditions": [
      {
        "paramName": "enableDataLayerMapping",
        "paramValue": true,
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "CHECKBOX",
    "name": "enableEdvancedMatching",
    "checkboxText": "Enable Advanced Matching",
    "simpleValueType": true,
    "help": "Enable sending users personal information such as email addresses, names, etc. to Meta. More information can be found \u003ca target\u003d\"_blank\" href\u003d\"https://developers.facebook.com/docs/meta-pixel/advanced/advanced-matching/\"\u003ehere\u003c/a\u003e."
  },
  {
    "type": "CHECKBOX",
    "name": "enableEventEnhancement",
    "checkboxText": "Enable Event Enhancement",
    "simpleValueType": true,
    "help": "Enable the use of LocalStorage to store data for enhanced event tracking.",
    "enablingConditions": [
      {
        "paramName": "enableEdvancedMatching",
        "paramValue": true,
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "complianceGroup",
    "displayName": "Compliance",
    "groupStyle": "ZIPPY_OPEN",
    "subParams": [
      {
        "type": "SELECT",
        "name": "consent",
        "displayName": "Consent Granted",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": true,
            "displayValue": "True"
          },
          {
            "value": false,
            "displayValue": "False"
          }
        ],
        "simpleValueType": true,
        "help": "Setting Consent Granted to \u003cstrong\u003efalse\u003c/strong\u003e will prevent the pixel from sending hits until tag fired with Consent Granted \u003cstrong\u003etrue\u003c/strong\u003e. More info \u003ca href\u003d\"hhttps://developers.facebook.com/docs/meta-pixel/implementation/gdpr\"\u003eby this link\u003c/a\u003e.",
        "enablingConditions": [
          {
            "paramName": "enableConsentMode",
            "paramValue": false,
            "type": "EQUALS"
          }
        ]
      },
      {
        "type": "CHECKBOX",
        "name": "enableConsentMode",
        "checkboxText": "Enable GTM consent mode support",
        "simpleValueType": true,
        "help": "If enabled, the tag will check for ad_storage, and if it not granted, it will set the Facebook pixel consent to revoke. After the consent is granted, it will automatically execute fbq(\u0027consent\u0027, \u0027grant\u0027);"
      },
      {
        "type": "CHECKBOX",
        "name": "dpoLDU",
        "checkboxText": "Limited Data Use (LDU)",
        "simpleValueType": true,
        "help": "Limited Data Use is a data processing option that gives you more control over how your data is used in Meta’s systems. More info \u003ca target\u003d\"_blank\" href\u003d\"https://developers.facebook.com/docs/meta-pixel/implementation/data-processing-options\"\u003eby this link\u003c/a\u003e."
      },
      {
        "type": "TEXT",
        "name": "dpoCountry",
        "displayName": "Country",
        "simpleValueType": true,
        "defaultValue": 0,
        "enablingConditions": [
          {
            "paramName": "dpoLDU",
            "paramValue": true,
            "type": "EQUALS"
          }
        ],
        "valueValidators": [
          {
            "type": "NUMBER"
          }
        ]
      },
      {
        "type": "TEXT",
        "name": "dpoState",
        "displayName": "State",
        "simpleValueType": true,
        "defaultValue": 0,
        "enablingConditions": [
          {
            "paramName": "dpoLDU",
            "paramValue": true,
            "type": "EQUALS"
          }
        ],
        "valueValidators": [
          {
            "type": "NUMBER"
          }
        ]
      }
    ]
  },
  {
    "displayName": "User Data",
    "name": "userDataListGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "type": "LABEL",
        "name": "userDataLabel",
        "displayName": "User Data Properties that you can send to Meta you can find \u003ca target\u003d\"_blank\" href\u003d\"https://developers.facebook.com/docs/meta-pixel/advanced/advanced-matching\"\u003eby this link\u003c/a\u003e.\u003cbr\u003e\u003cbr\u003e"
      },
      {
        "type": "SELECT",
        "name": "userDataFromVariable",
        "displayName": "Load Properties From Variable",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": false,
            "displayValue": "False"
          }
        ],
        "simpleValueType": true,
        "help": "You can use a standard User-Provided Data variable or create a variable that returns a JavaScript object with the desired user data properties. This object will merge with additional properties from the table below, with any conflicts resolved in favor of the table entries."
      },
      {
        "name": "userDataList",
        "simpleTableColumns": [
          {
            "valueValidators": [
              {
                "type": "NON_EMPTY"
              }
            ],
            "defaultValue": "em",
            "displayName": "Property Name",
            "name": "name",
            "isUnique": true,
            "type": "SELECT",
            "selectItems": [
              {
                "value": "em",
                "displayValue": "Email"
              },
              {
                "value": "ph",
                "displayValue": "Phone"
              },
              {
                "value": "ge",
                "displayValue": "Gender"
              },
              {
                "value": "db",
                "displayValue": "Date of Birth"
              },
              {
                "value": "ln",
                "displayValue": "Last Name"
              },
              {
                "value": "fn",
                "displayValue": "First Name"
              },
              {
                "value": "ct",
                "displayValue": "City"
              },
              {
                "value": "st",
                "displayValue": "State"
              },
              {
                "value": "zp",
                "displayValue": "Zip"
              },
              {
                "value": "country",
                "displayValue": "Country"
              },
              {
                "value": "external_id",
                "displayValue": "External ID"
              }
            ]
          },
          {
            "defaultValue": "",
            "displayName": "Property Value",
            "name": "value",
            "type": "TEXT"
          }
        ],
        "type": "SIMPLE_TABLE",
        "newRowButtonText": "Add property"
      }
    ],
    "help": "See \u003ca href\u003d\"https://developers.facebook.com/docs/meta-pixel/advanced/advanced-matching/\" target\u003d\"_blank\"\u003ethis documentation\u003c/a\u003e for more details on what user data parameters you can add to the call.",
    "enablingConditions": [
      {
        "paramName": "enableEdvancedMatching",
        "paramValue": true,
        "type": "EQUALS"
      }
    ]
  },
  {
    "displayName": "Object Properties",
    "name": "objectPropertiesGroup",
    "groupStyle": "ZIPPY_CLOSED",
    "type": "GROUP",
    "subParams": [
      {
        "type": "LABEL",
        "name": "objectPropertiesLabel",
        "displayName": "Standard Object Properties that you can send to Meta you can find \u003ca target\u003d\"_blank\" href\u003d\"https://developers.facebook.com/docs/meta-pixel/reference#object-properties\"\u003eby this link\u003c/a\u003e.\u003cbr\u003e\u003cbr\u003e"
      },
      {
        "type": "SELECT",
        "name": "objectPropertiesFromVariable",
        "displayName": "Load Properties From Variable",
        "macrosInSelect": true,
        "selectItems": [
          {
            "value": false,
            "displayValue": "False"
          }
        ],
        "simpleValueType": true,
        "help": "You can create a variable that returns a JavaScript object with the desired properties. This object will merge with additional properties from the table below, with any conflicts resolved in favor of the table entries."
      },
      {
        "name": "objectPropertiesList",
        "simpleTableColumns": [
          {
            "valueValidators": [],
            "defaultValue": "",
            "displayName": "Property Name",
            "name": "name",
            "isUnique": true,
            "type": "TEXT"
          },
          {
            "defaultValue": "",
            "displayName": "Property Value",
            "name": "value",
            "type": "TEXT"
          }
        ],
        "type": "SIMPLE_TABLE",
        "newRowButtonText": "Add property"
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "serverGroup",
    "displayName": "Server Side Tracking",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "type": "TEXT",
        "name": "eventId",
        "displayName": "Event ID",
        "simpleValueType": true,
        "help": "Set the Event ID parameter in case you are tracking the same event server-side as well. The Event ID can be used to deduplicate the same event if sent from multiple sources. See more \u003ca href\u003d\"https://developers.facebook.com/docs/marketing-api/conversions-api/deduplicate-pixel-and-server-events/\"\u003ehere\u003c/a\u003e."
      },
      {
        "type": "CHECKBOX",
        "name": "dataLayerEventPush",
        "checkboxText": "Push event to DataLayer with this eventId",
        "simpleValueType": true,
        "help": "Helpful for easier events deduplication.",
        "defaultValue": false
      },
      {
        "type": "TEXT",
        "name": "dataLayerEventName",
        "displayName": "DataLayer Event Name",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "dataLayerEventPush",
            "paramValue": true,
            "type": "EQUALS"
          }
        ],
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "valueHint": "page_view_unique"
      },
      {
        "type": "TEXT",
        "name": "dataLayerVariableName",
        "displayName": "DataLayer Object Name",
        "simpleValueType": true,
        "enablingConditions": [
          {
            "paramName": "dataLayerEventPush",
            "paramValue": true,
            "type": "EQUALS"
          }
        ],
        "valueValidators": [
          {
            "type": "NON_EMPTY"
          }
        ],
        "defaultValue": "dataLayer",
        "help": "Use dataLayer by default. Modify only if you renamed dataLayer object name."
      }
    ]
  },
  {
    "type": "GROUP",
    "name": "settingsGroup",
    "displayName": "Settings",
    "groupStyle": "ZIPPY_CLOSED",
    "subParams": [
      {
        "help": "Facebook automatically collects metadata and user interactions (e.g., clicks). Check this box to disable this functionality.",
        "simpleValueType": true,
        "name": "disableAutoConfig",
        "checkboxText": "Disable Automatic Configuration",
        "type": "CHECKBOX"
      },
      {
        "type": "CHECKBOX",
        "name": "disablePushState",
        "checkboxText": "Disable History Event Tracking",
        "simpleValueType": true,
        "help": "The Facebook Pixel automatically tracks history events (pushState and replaceState) as PageViews. Check this box to disable this automatic tracking."
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

const addConsentListener = require('addConsentListener');
const aliasInWindow = require('aliasInWindow');
const callInWindow = require('callInWindow');
const copyFromDataLayer = require('copyFromDataLayer');
const copyFromWindow = require('copyFromWindow');
const createQueue = require('createQueue');
const getType = require('getType');
const injectScript = require('injectScript');
const isConsentGranted = require('isConsentGranted');
const JSON = require('JSON');
const localStorage = require('localStorage');
const makeNumber = require('makeNumber');
const makeTableMap = require('makeTableMap');
const math = require('Math');
const Object = require('Object');
const setInWindow = require('setInWindow');

/*==============================================================================
==============================================================================*/

const partnerName = 'stape-gtm';
const queueName = 'fbq';
const queue = getQueue(queueName);
const initIds = copyFromWindow('_meta_gtm_ids') || [];
const ecommerceDataLayer = copyFromDataLayer('ecommerce', 1);
const dataLayerVersion = data.enableCurrentDataLayerOnly ? 1 : 2;

setConsent();
sendEvent();
sendDataLayerPush();

injectScript('https://connect.facebook.net/en_US/fbevents.js', data.gtmOnSuccess, data.gtmOnFailure, 'metaPixel');

/*==============================================================================
  Vendor related functions
==============================================================================*/

function getQueue(queueName) {
  let q = copyFromWindow(queueName);
  if (q) {
    return q;
  }

  setInWindow(queueName, function () {
    const callMethod = copyFromWindow(queueName + '.callMethod.apply');
    if (callMethod) {
      callInWindow(queueName + '.callMethod.apply', null, arguments);
    } else {
      callInWindow(queueName + '.queue.push', arguments);
    }
  });

  aliasInWindow('_' + queueName, queueName);
  createQueue(queueName + '.queue');

  return copyFromWindow(queueName);
}

function setConsent() {
  if (data.dpoLDU) {
    queue('dataProcessingOptions', ['LDU'], makeNumber(data.dpoCountry), makeNumber(data.dpoState));
  }

  if (data.enableConsentMode) {
    if (!isConsentGranted('ad_storage')) {
      queue('consent', 'revoke');

      let wasCalled = false;

      addConsentListener('ad_storage', (consentType, granted) => {
        if (wasCalled || consentType !== 'ad_storage' || !granted) return;
        wasCalled = true;

        queue('consent', 'grant');
      });

      return;
    }

    queue('consent', 'grant');

    return;
  }

  queue('consent', data.consent === false ? 'revoke' : 'grant');
}

function setSettings(pixelId) {
  if (data.disableAutoConfig) {
    queue('set', 'autoConfig', false, pixelId);
  }

  if (data.disablePushState) {
    setInWindow(queueName + '.disablePushState', true);
  }
}

function sendEvent() {
  const pixelIds = data.pixelIds;
  const eventName = getEventName();
  const command = getCommand(eventName);
  const eventData = getEventData(eventName);
  const userData = getUserData();

  pixelIds.split(',').forEach((pixelId) => {
    if (initIds.indexOf(pixelId) === -1) {
      setSettings();

      queue('init', pixelId, userData);
      queue('set', 'agent', partnerName, pixelId);

      initIds.push(pixelId);
      setInWindow('_meta_gtm_ids', initIds, true);
    }

    if (data.eventId) {
      queue(command, pixelId, eventName, eventData, { eventID: data.eventId });
    } else {
      queue(command, pixelId, eventName, eventData);
    }
  });
}

function getEventName() {
  if (data.inheritEventName === 'inherit') {
    let eventName = copyFromDataLayer('event');

    if (!eventName) {
      if (ecommerceDataLayer.detail) eventName = 'ViewContent';
      else if (ecommerceDataLayer.add) eventName = 'AddToCart';
      else if (ecommerceDataLayer.checkout) eventName = 'InitiateCheckout';
      else if (ecommerceDataLayer.purchase) eventName = 'Purchase';
    }

    let mapFacebookEventName = {
      page_view: 'PageView',
      'gtm.dom': 'PageView',
      add_payment_info: 'AddPaymentInfo',
      add_to_cart: 'AddToCart',
      add_to_wishlist: 'AddToWishlist',
      sign_up: 'CompleteRegistration',
      begin_checkout: 'InitiateCheckout',
      generate_lead: 'Lead',
      purchase: 'Purchase',
      search: 'Search',
      view_item: 'ViewContent',

      contact: 'Contact',
      customize_product: 'CustomizeProduct',
      donate: 'Donate',
      find_location: 'FindLocation',
      schedule: 'Schedule',
      start_trial: 'StartTrial',
      submit_application: 'SubmitApplication',
      subscribe: 'Subscribe',

      page_view_stape: 'PageView',
      add_payment_info_stape: 'AddPaymentInfo',
      add_to_cart_stape: 'AddToCart',
      sign_up_stape: 'CompleteRegistration',
      begin_checkout_stape: 'InitiateCheckout',
      purchase_stape: 'Purchase',
      view_item_stape: 'ViewContent',

      'gtm4wp.addProductToCartEEC': 'AddToCart',
      'gtm4wp.productClickEEC': 'ViewContent',
      'gtm4wp.checkoutOptionEEC': 'InitiateCheckout',
      'gtm4wp.checkoutStepEEC': 'AddPaymentInfo',
      'gtm4wp.orderCompletedEEC': 'Purchase'
    };

    if (!mapFacebookEventName[eventName]) {
      return eventName;
    }

    return mapFacebookEventName[eventName];
  }

  return data.eventName === 'standard' ? data.eventNameStandard : data.eventNameCustom;
}

function getCommand(eventName) {
  return [
    'AddPaymentInfo',
    'AddToCart',
    'AddToWishlist',
    'CompleteRegistration',
    'Contact',
    'CustomizeProduct',
    'Donate',
    'FindLocation',
    'InitiateCheckout',
    'Lead',
    'PageView',
    'Purchase',
    'Schedule',
    'Search',
    'StartTrial',
    'SubmitApplication',
    'Subscribe',
    'ViewContent'
  ].indexOf(eventName) === -1
    ? 'trackSingleCustom'
    : 'trackSingle';
}

function getUserData() {
  if (!data.enableEdvancedMatching) {
    return;
  }

  let userData = {};

  if (data.enableEventEnhancement) {
    userData = getEventEnhancement(userData);
  }

  if (data.enableDataLayerMapping) {
    let userDataFromDataLayer = getDL('user_data');

    if (getType(userDataFromDataLayer) === 'object') {
      parseUserData(userData, userDataFromDataLayer, true);
    }
  }

  if (getType(data.userDataFromVariable) === 'object') {
    parseUserData(userData, data.userDataFromVariable, false);
  }

  if (data.userDataList && data.userDataList.length) {
    userData = mergeObjects(userData, makeTableMap(data.userDataList, 'name', 'value'));
  }

  if (data.enableEventEnhancement) {
    storeEventEnhancement(userData);
  }

  return userData;
}

function getEventData(eventName) {
  let objectProperties = {};

  if (data.enableDataLayerMapping) {
    const ecommerce = getDL('ecommerce');

    if (ecommerce) {
      objectProperties = getUAEventData(eventName, objectProperties, ecommerce);
    }
    if (!objectProperties.content_type) {
      objectProperties = getGA4EventData(eventName, objectProperties, ecommerce);
    }
  }

  if (getType(data.objectPropertiesFromVariable) === 'object') {
    mergeObjects(objectProperties, data.objectPropertiesFromVariable);
  }

  if (data.objectPropertiesList && data.objectPropertiesList.length) {
    objectProperties = mergeObjects(objectProperties, makeTableMap(data.objectPropertiesList, 'name', 'value'));
  }

  return objectProperties;
}

function getEventEnhancement() {
  if (localStorage) {
    const gtmeec = localStorage.getItem('gtmeec');

    if (gtmeec) {
      const gtmeecParsed = JSON.parse(gtmeec);

      if (getType(gtmeecParsed) === 'object') {
        return gtmeecParsed;
      }
    }
  }

  return {};
}

function storeEventEnhancement(userData) {
  if (localStorage && userData) {
    const gtmeec = JSON.stringify(userData);

    if (gtmeec) {
      localStorage.setItem('gtmeec', gtmeec);
    }
  }
}

function sendDataLayerPush() {
  if (data.dataLayerEventPush) {
    const dataLayerQueueName = data.dataLayerVariableName || 'dataLayer';
    const dataLayerPush = createQueue(dataLayerQueueName);

    dataLayerPush({ eventId: data.eventId, event: data.dataLayerEventName || 'DefaultTagEvent' });
  }
}

function mergeObjects(obj1, obj2) {
  Object.keys(obj2).forEach((key) => {
    obj1[key] = obj2[key];
  });

  return obj1;
}

function parseUserData(userData, userDataFrom, useDL) {
  if (userDataFrom.email) userData.em = userDataFrom.email;
  else if (userDataFrom.sha256_email_address) userData.em = userDataFrom.sha256_email_address;
  else if (userDataFrom.email_address) userData.em = userDataFrom.email_address;
  else if (userDataFrom.em) userData.em = userDataFrom.em;

  if (userDataFrom.phone) userData.ph = userDataFrom.phone;
  else if (userDataFrom.sha256_phone_number) userData.ph = userDataFrom.sha256_phone_number;
  else if (userDataFrom.phone_number) userData.ph = userDataFrom.phone_number;
  else if (userDataFrom.ph) userData.ph = userDataFrom.ph;

  if (userDataFrom.firstName) userData.fn = userDataFrom.firstName;
  else if (userDataFrom.nameFirst) userData.fn = userDataFrom.nameFirst;
  else if (userDataFrom.first_name) userData.fn = userDataFrom.first_name;
  else if (userDataFrom.fn) userData.fn = userDataFrom.fn;
  else if (userDataFrom.address && userDataFrom.address.sha256_first_name) userData.fn = userDataFrom.address.sha256_first_name;
  else if (userDataFrom.address && userDataFrom.address.first_name) userData.fn = userDataFrom.address.first_name;

  if (userDataFrom.lastName) userData.ln = userDataFrom.lastName;
  else if (userDataFrom.nameLast) userData.ln = userDataFrom.nameLast;
  else if (userDataFrom.last_name) userData.ln = userDataFrom.last_name;
  else if (userDataFrom.ln) userData.ln = userDataFrom.ln;
  else if (userDataFrom.address && userDataFrom.address.sha256_last_name) userData.ln = userDataFrom.address.sha256_last_name;
  else if (userDataFrom.address && userDataFrom.address.last_name) userData.ln = userDataFrom.address.last_name;

  if (userDataFrom.ge) userData.ge = userDataFrom.ge;
  if (userDataFrom.db) userData.db = userDataFrom.db;

  if (userDataFrom.city) userData.ct = userDataFrom.city;
  else if (userDataFrom.ct) userData.ct = userDataFrom.ct;
  else if (userDataFrom.address && userDataFrom.address.city) userData.ct = userDataFrom.address.city;

  if (userDataFrom.state) userData.st = userDataFrom.state;
  else if (userDataFrom.region) userData.st = userDataFrom.region;
  else if (userDataFrom.st) userData.st = userDataFrom.st;
  else if (userDataFrom.address && userDataFrom.address.state) userData.st = userDataFrom.address.state;
  else if (userDataFrom.address && userDataFrom.address.region) userData.st = userDataFrom.address.region;

  if (userDataFrom.zip) userData.zp = userDataFrom.zip;
  else if (userDataFrom.postal_code) userData.zp = userDataFrom.postal_code;
  else if (userDataFrom.zp) userData.zp = userDataFrom.zp;
  else if (userDataFrom.address && userDataFrom.address.postal_code) userData.zp = userDataFrom.address.postal_code;
  else if (userDataFrom.address && userDataFrom.address.zip) userData.zp = userDataFrom.address.zip;

  if (userDataFrom.country) userData.country = userDataFrom.country;
  else if (userDataFrom.address && userDataFrom.address.country) userData.country = userDataFrom.address.country;

  if (userDataFrom.external_id) userData.external_id = userDataFrom.external_id;
  else if (userDataFrom.user_id) userData.external_id = userDataFrom.user_id;
  else if (userDataFrom.userId) userData.external_id = userDataFrom.userId;
  else if (useDL && getDL('external_id')) userData.external_id = getDL('external_id');
  else if (useDL && getDL('user_id')) userData.external_id = getDL('user_id');
  else if (useDL && getDL('userId')) userData.external_id = getDL('userId');

  return userData;
}

function getUAEventData(eventName, objectProperties, ecommerce) {
  const eventActionMap = {
    ViewContent: 'detail',
    AddToCart: 'add',
    InitiateCheckout: 'checkout',
    Purchase: 'purchase'
  };

  if (eventActionMap[eventName]) {
    let action = eventActionMap[eventName];

    if (ecommerce[action] && ecommerce[action].products && getType(ecommerce[action].products) === 'array') {
      objectProperties = {
        content_type: 'product',
        contents: ecommerce[action].products.map((prod) => ({ id: prod.id, quantity: makeNumber(prod.quantity) || 1, item_price: makeNumber(prod.price) })),
        content_ids: ecommerce[action].products.map((prod) => prod.id),
        value: ecommerce[action].products.reduce((acc, cur) => {
          const curVal = math.round(makeNumber(cur.price || 0) * (cur.quantity || 1) * 100) / 100;
          return acc + curVal;
        }, 0.0),
        currency: ecommerce.currencyCode || 'USD'
      };

      if (['InitiateCheckout', 'Purchase'].indexOf(eventName) > -1)
        objectProperties.num_items = ecommerce[action].products.reduce((acc, cur) => {
          return acc + makeNumber(cur.quantity || 1);
        }, 0);
    }
  }

  return objectProperties;
}

function getGA4EventData(eventName, objectProperties, ecommerce) {
  let items = getDL('items');
  if (!items && ecommerce && ecommerce.items) {
    items = ecommerce.items;
  }
  let currencyFromItems = '';
  let valueFromItems = 0;

  if (items && items[0]) {
    objectProperties.contents = [];
    objectProperties.content_ids = [];
    objectProperties.content_type = 'product';
    if (['InitiateCheckout', 'Purchase'].indexOf(eventName) > -1) {
      objectProperties.num_items = 0;
    }
    currencyFromItems = items[0].currency;

    if (!items[1]) {
      if (items[0].item_name) objectProperties.content_name = items[0].item_name;
      if (items[0].item_category) objectProperties.content_category = items[0].item_category;
      if (items[0].price) objectProperties.value = items[0].quantity ? items[0].quantity * items[0].price : items[0].price;
    }

    items.forEach((d, i) => {
      let content = {};
      if (d.item_id) content.id = d.item_id;
      content.quantity = makeNumber(d.quantity) || 1;

      if (d.price) {
        let item_price = makeNumber(d.price);
        valueFromItems += d.quantity ? d.quantity * item_price : item_price;
        content.item_price = item_price;
      }

      objectProperties.contents.push(content);
      objectProperties.content_ids.push(content.id);
      if (['InitiateCheckout', 'Purchase'].indexOf(eventName) > -1) {
        objectProperties.num_items = objectProperties.num_items + content.quantity || 1;
      }
    });
  }

  if (getDL('value')) objectProperties.value = getDL('value');

  if (getDL('currency')) objectProperties.currency = getDL('currency');
  else if (currencyFromItems) objectProperties.currency = currencyFromItems;

  if (getDL('search_term')) objectProperties.search_string = getDL('search_term');

  if (eventName === 'Purchase') {
    if (!objectProperties.currency) objectProperties.currency = 'USD';
    if (!objectProperties.value) objectProperties.value = valueFromItems ? valueFromItems : 0;
  }

  return objectProperties;
}

function getDL(name) {
  return copyFromDataLayer(name, dataLayerVersion);
}


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "fbq"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_meta_gtm_ids"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_fbq"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "fbq.callMethod.apply"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "fbq.queue.push"
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "fbq.queue"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "fbq.disablePushState"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "dataLayer"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_data_layer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "allowedKeys",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://connect.facebook.net/en_US/fbevents.js"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_local_storage",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "gtmeec"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_consent",
        "versionId": "1"
      },
      "param": [
        {
          "key": "consentTypes",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Event ID
  code: "mockData.eventId = 'eventId';\n\nmock('copyFromWindow', key => {\n  if (key\
    \ === 'fbq') return function() {\n    if (arguments[0] === 'trackSingle') {\n\
    \      assertThat(arguments[4], 'eventId not set').isEqualTo({eventID: mockData.eventId});\n\
    \    }\n  };\n});\n     \nrunCode(mockData);\nassertApi('gtmOnSuccess').wasCalled();"
setup: |-
  const mockData = {
    pixelIds: '123456789,987654321',
    consent: true,
    eventId: 'test'
  };


  let success, failure;
  mock('injectScript', (url, onsuccess, onfailure) => {
    success = onsuccess;
    failure = onfailure;
    onsuccess();
  });

  mock('copyFromWindow', key => {
    if (key === 'fbq') return () => {};
    if (key === 'dataLayer') return () => {};
  });


___NOTES___

Created on 08/15/2025, 08:58:45 AM


